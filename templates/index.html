{% extends "base.html" %}

{% block title %}ダッシュボード{% endblock %}

{% block extra_css %}
<script src='https://kit.fontawesome.com/a076d05399.js'></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    
    .dashboard-container {
        padding: 20px;
    }
    
    .chart-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .chart-title {
        font-size: 1.2em;
        color: #333;
    }
    
    .records-section {
        margin-top: 10px;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }
    
    .records-toggle {
        background: #f5f5f5;
        border: none;
        padding: 10px;
        width: 100%;
        text-align: left;
        cursor: pointer;
        border-radius: 4px;
    }
    
    .records-toggle:hover {
        background: #ebebeb;
    }
    
    .records-content {
        padding: 15px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .records-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .records-table th,
    .records-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .leaderboard-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 30px;
    }
    
    .leaderboard {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .leaderboard-title {
        font-size: 1.2em;
        color: #333;
        margin-bottom: 15px;
    }
    
    .leaderboard-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .leaderboard-table th,
    .leaderboard-table td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .rank {
        font-weight: bold;
        color: #4CAF50;
    }

    /* 加载状态样式 */
    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
    }

    .loading::after {
        content: '...';
        animation: dots 1s steps(5, end) infinite;
    }

    @keyframes dots {
        0%, 20% { content: '.'; }
        40% { content: '..'; }
        60% { content: '...'; }
        80%, 100% { content: ''; }
    }

    /* 错误信息样式 */
    .error {
        text-align: center;
        padding: 20px;
        color: #d32f2f;
        background-color: #ffebee;
        border-radius: 4px;
        margin: 10px 0;
    }

    /* 空数据样式 */
    .no-data {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
        background-color: #f5f5f5;
        border-radius: 4px;
        margin: 10px 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Tab -->
<div id="dashboardTab" class="tab-content {% if active_tab == 'dashboard' %}active{% endif %}">
    <div class="dashboard-container">
        <!-- 文章を読む Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">文章を読む - スコア履歴</h3>
            </div>
            <canvas id="readingChart"></canvas>
            <div class="records-section">
                <button class="records-toggle" onclick="toggleRecords('readingRecords')">
                    詳細記録を表示 ▼
                </button>
                <div id="readingRecords" class="records-content" style="display: none;">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>文章</th>
                                <th>正確性</th>
                                <th>流暢さ</th>
                                <th>完全性</th>
                                <th>発音</th>
                            </tr>
                        </thead>
                        <tbody id="readingRecordsBody">
                            <!-- JavaScript で動的に追加 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Topic Chart Section -->
        <div class="chart-section">
            <div class="chart-header">
                <h3 class="chart-title">Topic - スコア履歴</h3>
            </div>
            <canvas id="topicChart"></canvas>
            <div class="records-section">
                <button class="records-toggle" onclick="toggleRecords('topicRecords')">
                    詳細記録を表示 ▼
                </button>
                <div id="topicRecords" class="records-content" style="display: none;">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>日付</th>
                                <th>トピック</th>
                                <th>文法</th>
                                <th>内容</th>
                                <th>関連性</th>
                            </tr>
                        </thead>
                        <tbody id="topicRecordsBody">
                            <!-- JavaScript で動的に追加 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Leaderboards -->
        <div class="leaderboard-container">
            <!-- Reading Leaderboard -->
            <div class="leaderboard">
                <h3 class="leaderboard-title">文章を読む - ランキング</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>順位</th>
                            <th>ユーザー</th>
                            <th>平均スコア</th>
                        </tr>
                    </thead>
                    <tbody id="readingLeaderboard">
                        <!-- JavaScript で動的に追加 -->
                    </tbody>
                </table>
            </div>

            <!-- Topic Leaderboard -->
            <div class="leaderboard">
                <h3 class="leaderboard-title">Topic - ランキング</h3>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>順位</th>
                            <th>ユーザー</th>
                            <th>平均スコア</th>
                        </tr>
                    </thead>
                    <tbody id="topicLeaderboard">
                        <!-- JavaScript で動的に追加 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 文章を読む Tab -->
<div id="readTab" class="tab-content active">
    <div class="container" id="ttscont">
    </div>

    <div class=container id="formcontainer">
        <form id="reftextform">
            <textarea id="reftext" rows="3" cols="80" name="reftext" maxlength="160" autofocus placeholder="ここに参照テキストを入力してください..."></textarea>
        </form>
        <br>
    </div>

    <div class="button-container">
        <button id="buttonhear" class="h-button">
            <span class="fas fa-headphones"></span>発音を学ぶ</button>
        <button id="randomtt" class="blue-button">
            <span class="fa fa-random"></span>ランダム</button>
        <button id="generateText" class="blue-button">
            <span class="fa fa-file-alt"></span>ランダム文章</button>
        <button id="buttonmic" class="green-button">
            <span class="fa fa-microphone"></span>新しい録音</button>
    </div>

    <div class="container" id="recordcont">
        <div id="ttsList"></div>
        <div class="container" id="ttsloader">
            <div id="loader"></div>
        </div>
        <div id="recordingsList"></div>

        <div class="container" id="recordloader">
            <div id="loader"></div>
        </div>
        
        <div id="metrics" class="animate-bottom">
            <div class=container>
                <div id="summarytable">
                    <table>
                        <tr>
                            <th>正確性スコア</th>
                            <th>流暢さスコア</th>
                            <th>完全性スコア</th>
                            <th>発音スコア</th>
                            <th id="woh">省略された単語</th>
                            <th id="wih">余分に話された単語</th>
                        </tr>
                        <tr>
                            <td id="accuracyscore"></td>
                            <td id="fluencyscore"></td>
                            <td id="completenessscore"></td>
                            <td id="pronscore"></td>
                            <td id="wordsomitted"></td>
                            <td id="wordsinserted"></td>
                        </tr>
                    </table>
                </div>
            </div>
            
            <div class="container">
                <div id="detailedtable">
                    <table>
                        <tr id="wordrow"></tr>
                        <tr id="phonemerow"></tr>
                        <tr id="scorerow"></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Topic Tab -->
<div id="topicTab" class="tab-content">
    <div class="container">
        <textarea id="topicText" rows="3" cols="80" placeholder="ここにトピックが表示されます..."></textarea>
    </div>
    <div class="button-container">
        <button id="generateTopic" class="blue-button">
            <span class="fa fa-lightbulb"></span>トピックを生成</button>
        <button id="recordTopic" class="green-button">
            <span class="fa fa-microphone"></span>録音</button>
    </div>
    <div class="container">
        <textarea id="transcribedText" rows="5" cols="80" placeholder="ここに音声認識の結果が表示されます..." readonly></textarea>
    </div>
    <div class="container">
        <div class="feedback-section">
            <h3>文法の修正</h3>
            <textarea id="grammarCorrection" rows="5" cols="80" placeholder="文法の修正と提案が表示されます..." readonly></textarea>
            <h3>フィードバック</h3>
            <div id="feedbackContent" class="feedback-content">
                <div class="score-section">
                    <h4>評価スコア</h4>
                    <div class="score-items">
                        <div class="score-item">
                            <span class="score-label">文法:</span>
                            <span id="grammarScore" class="score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">内容:</span>
                            <span id="contentScore" class="score">-</span>
                        </div>
                        <div class="score-item">
                            <span class="score-label">トピックとの関連性:</span>
                            <span id="relevanceScore" class="score">-</span>
                        </div>
                    </div>
                </div>
                <div class="feedback-text">
                    <h4>アドバイス</h4>
                    <textarea id="feedbackText" rows="5" cols="80" placeholder="アドバイスが表示されます..." readonly></textarea>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 練習 Tab -->
<div id="practiceTab" class="tab-content">
    <!-- 将来的に追加する練習コンテンツ -->
</div>

<footer id=footeralert>マイクの使用を許可してください。</footer>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script src="{{ url_for('static', filename='index.js') }}"></script>
<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
<script>
function toggleRecords(recordsId) {
    const content = document.getElementById(recordsId);
    const button = content.previousElementSibling;
    if (content.style.display === 'none') {
        content.style.display = 'block';
        button.innerHTML = '詳細記録を隠す ▲';
    } else {
        content.style.display = 'none';
        button.innerHTML = '詳細記録を表示 ▼';
    }
}
</script>
{% endblock %}
